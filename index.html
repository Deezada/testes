<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acompanhamento de Estudos - Assistente Técnico Administrativo</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .subject-card, .section-card {
            background-color: #ffffff;
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Softer shadow */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .topic-item, .schedule-item, .review-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0; /* Lighter border */
        }
        .topic-item:last-child, .schedule-item:last-child, .review-item:last-child {
            border-bottom: none;
        }
        .status-select, .date-input, .time-input, .text-input {
            padding: 0.4rem 0.6rem;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1;
            background-color: #f8fafc;
            font-size: 0.875rem;
            color: #475569;
        }
        .date-input, .time-input {
            width: 120px; /* Fixed width for date/time input */
        }
        .progress-bar-container {
            background-color: #e2e8f0;
            border-radius: 9999px;
            height: 0.75rem;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .progress-bar {
            background-color: #3b82f6; /* Blue progress bar */
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50; /* Green for success */
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
        }
        .btn-primary {
            @apply bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors duration-200;
        }
        .btn-secondary {
            @apply bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors duration-200;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #334155;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.6rem;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1;
            background-color: #f8fafc;
            font-size: 0.9rem;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        /* Sidebar specific styles */
        .sidebar-nav-link.active-nav-link {
            background-color: #e0f2fe; /* Light blue for active link */
            color: #1d4ed8; /* Darker blue text */
            font-weight: 600;
        }
        .sidebar-module-toggle {
            cursor: pointer;
            font-weight: 600;
            color: #334155;
            padding: 0.5rem 0;
            display: flex;
            align-items: center;
        }
        .sidebar-module-toggle svg {
            transition: transform 0.2s ease-in-out;
        }
        .sidebar-module-toggle.collapsed svg {
            transform: rotate(-90deg);
        }
        .sidebar-subject-list {
            padding-left: 1rem;
            border-left: 2px solid #e2e8f0;
            margin-top: 0.5rem;
        }
        .sidebar-subject-link {
            display: block;
            padding: 0.4rem 0.75rem;
            border-radius: 0.5rem;
            color: #475569;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .sidebar-subject-link:hover {
            background-color: #f0f4f8;
            color: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex">
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-lg text-gray-700">Carregando seu progresso...</p>
    </div>

    <div id="messageBox" class="message-box"></div>

    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-lg flex flex-col">
        <!-- Logo/Header of Sidebar -->
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800">Estudos Concurso</h2>
        </div>

        <!-- Main Navigation -->
        <nav class="flex-grow p-4 space-y-2">
            <a href="#" id="navOverview" class="sidebar-nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-700 active-nav-link">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                Visão Geral
            </a>
            <a href="#" id="navSchedule" class="sidebar-nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-700">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                Cronograma
            </a>
            <a href="#" id="navReviews" class="sidebar-nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-100 hover:text-blue-700">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                Revisões Manuais
            </a>
        </nav>

        <!-- Dynamic Modules and Subjects -->
        <div id="sidebarModules" class="p-4 border-t border-gray-200">
            <!-- Modules and subjects will be dynamically loaded here -->
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header (existing) -->
        <header class="bg-blue-600 text-white p-6 shadow-md">
            <div class="container flex flex-col sm:flex-row justify-between items-center">
                <h1 class="text-3xl font-bold mb-2 sm:mb-0">Meu Plano de Estudos</h1>
                <div class="text-sm">
                    <p>Cargo: Assistente Técnico Administrativo - Nível Médio</p>
                    <p id="userIdDisplay" class="mt-1">ID do Usuário: Carregando...</p>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="flex-1 overflow-y-auto p-8">
            <!-- Overall Progress (now part of syllabus section logic) -->
            <div id="overallProgress" class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Progresso Geral</h2>
                <div class="progress-bar-container">
                    <div id="overallProgressBar" class="progress-bar" style="width: 0%;"></div>
                </div>
                <p id="overallProgressText" class="text-gray-600 text-sm mt-2">0% Concluído</p>
            </div>

            <!-- Syllabus Section -->
            <section id="syllabusSection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Subjects will be loaded here by JavaScript -->
            </section>

            <!-- Schedule Section -->
            <section id="scheduleSection" class="hidden">
                <div class="section-card">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Adicionar Item ao Cronograma</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="scheduleSubject">Matéria:</label>
                            <select id="scheduleSubject" class="form-control">
                                <option value="">Selecione a Matéria</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="scheduleTopic">Tópico:</label>
                            <select id="scheduleTopic" class="form-control" disabled>
                                <option value="">Selecione o Tópico</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="scheduleDate">Data:</label>
                            <input type="date" id="scheduleDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="scheduleTime">Hora:</label>
                            <input type="time" id="scheduleTime" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="scheduleNotes">Notas:</label>
                        <textarea id="scheduleNotes" class="form-control" placeholder="Adicione notas sobre a sessão de estudo"></textarea>
                    </div>
                    <button id="addScheduleBtn" class="btn-primary mt-4">Adicionar ao Cronograma</button>
                </div>

                <div class="section-card mt-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Próximas Sessões</h2>
                    <div id="upcomingScheduleList" class="space-y-2">
                        <p class="text-gray-600">Nenhuma sessão agendada.</p>
                    </div>
                </div>

                <div class="section-card mt-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Sessões Anteriores</h2>
                    <div id="pastScheduleList" class="space-y-2">
                        <p class="text-gray-600">Nenhuma sessão anterior.</p>
                    </div>
                </div>
            </section>

            <!-- Reviews Section -->
            <section id="reviewsSection" class="hidden">
                <div class="section-card">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Tópicos para Revisão Manual</h2>
                    <div id="topicsForReviewList" class="space-y-2">
                        <p class="text-gray-600">Nenhum tópico marcado para revisão.</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer (existing) -->
        <footer class="bg-gray-800 text-white p-4 text-center text-sm">
            <p>&copy; 2025 Acompanhamento de Estudos. Todos os direitos reservados.</p>
        </footer>
    </div>
</body>
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBn-72h4ywM1rtsfTH0gqhWB41HHmwn8HM",
            authDomain: "editalkeeper.firebaseapp.com",
            projectId: "editalkeeper",
            storageBucket: "editalkeeper.firebasestorage.app",
            messagingSenderId: "272457283551",
            appId: "1:272457283551:web:a40173c76661143027b66a",
            measurementId: "G-005KE6KNYK" // Measurement ID is for Analytics, not strictly needed for core app
        };

        // Global variables based on your Firebase config
        const appId = firebaseConfig.appId; // Use appId from your config
        const initialAuthToken = null; // No custom token needed for local/GitHub Pages setup

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthReady = false;

        // --- Utility Functions ---
        function showMessageBox(message, type = 'success') {
            const messageBox = document.getElementById('messageBox');
            if (messageBox) { // Defensive check
                messageBox.textContent = message;
                messageBox.className = `message-box show bg-${type === 'success' ? 'green' : 'red'}-500`;
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 3000);
            } else {
                console.error("MessageBox element not found.");
            }
        }

        // --- Syllabus Data (New Nested Structure) ---
        const syllabusModules = [
            {
                id: "modulo-1",
                name: "MÓDULO I - CONHECIMENTOS GERAIS",
                subjects: {
                    "Língua Portuguesa": [
                        "Compreensão e interpretação de texto.", "Tipologia e gêneros textuais.", "Figuras de linguagem.",
                        "Significação de palavras e expressões.", "Relações de sinonímia e de antonímia.", "Ortografia.",
                        "Acentuação gráfica.", "Uso da crase.", "Morfologia: classes de palavras variáveis e invariáveis e seus empregos no texto.",
                        "Locuções verbais (perífrases verbais).", "Funções do 'que' e do 'se'.", "Formação de palavras.",
                        "Elementos de comunicação.", "Sintaxe: relações sintático-semânticas estabelecidas entre orações, períodos ou parágrafos (período simples e período composto por coordenação e subordinação).",
                        "Concordância verbal e nominal.", "Regência verbal e nominal.", "Colocação pronominal.",
                        "Emprego dos sinais de pontuação e sua função no texto.", "Elementos de coesão.", "Função textual dos vocábulos.",
                        "Variação linguística."
                    ],
                    "Estatística": [
                        "Conceitos básicos de estatística: população, amostra, variável, dados.",
                        "Tipos de variáveis: qualitativas (nominal, ordinal) e quantitativas (discreta, contínua).",
                        "Tabelas e gráficos: frequência absoluta e relativa, gráficos de barras, setores, histogramas.",
                        "Medidas de tendência central: média, mediana, moda.",
                        "Medidas de dispersão: amplitude, variância, desvio padrão.",
                        "Noções de probabilidade: experimento aleatório, evento, espaço amost
